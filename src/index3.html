<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      // https://stackoverflow.com/questions/19705785/python-3-simple-https-server
      const apiKey = 'f6d90bb8275f9f5ae69af1296c9d8157';
      const vibrationToPauseRatio = 0.95; // used for tuning timing on low-quality vibrator motors

      const getCurrentPosition = () => {
        // https://www.w3schools.com/html/html5_geolocation.asp
        return new Promise((resolve, reject) => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (position) => {
              resolve(position.coords);
            });
          } else {
            const err = 'Geolocation is not supported by this browser.';
            console.error(err);
            reject(err);
          }
        });
      };

      const getWeatherData = async ({ longitude, latitude }) => {
        // https://openweathermap.org/api/one-call-api
        // openweathermap api javascript: https://bithacker.dev/fetch-weather-openweathermap-api-javascript
        // get API key: https://home.openweathermap.org/api_keys
        const url = `https://api.openweathermap.org/data/2.5/onecall?lat=${latitude}&lon=${longitude}&appid=${apiKey}`;
        const res = await fetch(url);
        const json = await res.json();
        return json;
      };

      const getVibrationPattern = (weatherData) => {
        // see ideas.md
        const constrainValue = (input, in_mid, in_dev, out_mid, out_dev) =>
          out_mid * (1 + out_dev * Math.tanh((input - in_mid) / in_dev));
        const CelciusToKelvin = (C) => C + 273.15;

        // https://openweathermap.org/api/one-call-api
        const curatedData = [weatherData.current];
        var vibrationPattern = [];
        for (var data of curatedData) {
          vibrationPattern = vibrationPattern.concat([
            constrainValue(data.temp, CelciusToKelvin(5), -20, 1000, 15 / 16) *
              vibrationToPauseRatio,
            constrainValue(data.humidity, 50, 40, 1000, 15 / 16) /
              vibrationToPauseRatio,
            constrainValue(data.wind_speed, 0, 10, 1000 * (1 / 16), 2) *
              vibrationToPauseRatio,
          ]);
        }
        console.log(weatherData);
        return vibrationPattern;
      };

      const getPatternLength = (pattern) =>
        pattern.reduce((acc, cur) => acc + cur, 0);

      const init = async () => {
        document.removeEventListener('click', init);

        const position = await getCurrentPosition();
        var vibrationPattern = null;
        const fetch = async () => {
          try {
            const data = await getWeatherData(position);
            vibrationPattern = getVibrationPattern(data);
          } catch (e) {
            console.error(e);
          }
        };
        // limit the number of requests to the OpenWeatherMap API
        // limited at 1000 requests per day: 1000 * 60 * second in hours = 16.67 hours uptime per day
        setTimeout(fetch, 0);
        setInterval(fetch, 60 * 1000);

        const vibrate = async () => {
          if (vibrationPattern === null) return setTimeout(vibrate, 100);
          setTimeout(vibrate, getPatternLength(vibrationPattern) * 0 + 8000);
          navigator.vibrate(vibrationPattern);
          console.log('Sending Vibration: ', vibrationPattern);
        };
        vibrate();

        // change body background to show success
        document.body.style.backgroundColor = '#000';
      };
      document.addEventListener('click', init);
    </script>
  </body>
</html>
